# Chapter 2 - Deploying Ansible

## Building and Ansible Inventory
### Defining the Inventory
* Defines a collection of hosts that Ansible will manage
* Hosts can be assigned to groups to be managed collectively
* Groups can contain child groups
* Hosts can be part of multiple groups
* Host inventories can be *static* txt file or *dynamic* generated by a script

### Speciffying Managed Hosts with a Static Inventory
* Can be definec in INI-style or YAML.  INI-style is mor common
* Hosts can be organized into host groups
* Hosts can be part of multiple groups
* Two host groups *all* and *ungrouped* always exist

```
[webservers]
web1.example.com
web2.example.com

[db-servers]
db1.example.com
db2.example.com
192.23.23.234

[west-servers]
db1.example.com
web1.example.com
```

#### Defining Nested Groups
* host inventories can include groups of host groups.  This is accomplished by using the *:children* suffix
```
[usa]
web1.example.com
web2.example.com

[canada]
can1.example.com
can2.example.com

[north-america:children]
canada
usa
```

#### Simplifying Host Specifications with Ranges
You can specify ranges in host names or IP Addresses using the following syntax
```
[start:end]

192.168.[4:7].[0:255]

server[01:10].example.com
```

#### Verfying the Inventory
* Ansible command to verify a machines presence in a group:
```
ansible washington1.example.com --list-hosts
```
* Ansible command to list all hosts in a group
```
ansible canada --list-hosts
```

#### Overriding the Location of the Inventory
* */etc/ansible/hosts* is the system's default static inventory file
* *Normal practice is not to use this file*
* The *ansible* and *ansible-playbook* commands can use --inventory PATHNAME or -i PATHNAME to specify a desired inventory file

### Describing a Dynamic Inventory
* A number of dynamic inventory scripts are available from the upstream Ansible project


## Managing Ansible Configuration Files

### Configuring Ansible
* Ansible chooses its config files from several possible locations.  
	* */etc/ansible/ansible.cfg* (If no other file is described)
	* *~/.ansible.cfg* (Second Priority)
	* *./ansible.cfg* (First Priority)
* Using the *ANSIBLE_CONFIG* env variable
	* when this variable is defined the file described in the variable is used
	
### Configuration File Precedence
* Reverse order of the list described above
* ANSIBLE_CONFIG env variable overrides everything else
* Find which file is being used with:
```
ansible --version

or

ansible servers --list-hosts -v
```

### Managing Settings in the Configuration File
* *[defaults]* sets defaults for Ansible operations
* *[privilege_excalation]* configures how Ansible performs privilege escalation on managed hosts

```
[defaults]
inventory = ./inventory
remote_user = user
ask_pass = pass

[privilege_escalation]
become = true
become_method = sudo
become_user = root
become_ask_pass = false
```
Table: Ansible Configurations
| Directive        	| Description           							|
| ------------- 	|:--------------------------------------------------|
| inventory      	| path to inventory file							|
| remote_user     	| name of user to long in managed hosts      		|
| ask_pass		 	| is ssh passwd required?     						| 
| become			| switch user to root (typically) on managed host	|
| become_method		| How to switch user								|
| become_user		| User to swith to in managed host					|
| become_ask_pass	| prompt for password for your become_method		|


### Configuring Connections

* Ansible needs to know how to communicate with its managed hosts.  
* controlling which methods and users Ansible uses to administer managed hosts is a common reason to update configuration file
	* Location of the inventory file
	* Which connection protocol to use.  Does a non standard network port need to be used?
	* Which remote user to use on the managed hosts
	* If remote user in unprivileged, how should it escalate privileges to root
	* Prompt for ssh password?
* *Connection Settings*
	* this section basically re-iterated the above settings in a more verbose way
* *Excalating Privileges*
	* this section basically re-iterated the above settings in a more verbose way
* *Non-SSH Connections*
	* The protocol used by Ansible to connect to manageed hosts is set by default to **smart**
	* If you do not have localhost in your inventory ansible sets up an implicit localhost and uses **local** instead of **smart**
	* **local** ignores the **remote_user** setting and runs commands directly on the local system
	* change the protocol used to connect to **localhost** to use SSH like other managed hosts
		* set **ansible_connection** host variable for **localhost**.  Create a *host_vars* subdirectory and a *localhost* file within it with the line *ansible_connection: smart*
		

## Running Ad Hoc Commands

### Running Ad Hoc Commands with Ansible
* Executing a single Ansible task quickly, that you do not need to save to run again later
* Can be done without writing a playbook

* **Ansible Ad Hoc Commands**
```
ansible host-pattern -m  module [-a 'module arguments'] [-i inventory]
```

* The host pattern specifies the managed hosts on which the adhoc command should be run
* -m takes a module as an argument that Ansible should run on the targeted hosts.  
	* Modules are small programs that are executed to implement your task

* **Performing Tasks with Modules Using Ad Hoc Commands**
	* Ansible provides hundreds of modules which do diff things.  You can usually find what you need
	* **ansible-doc** *-l* command lists all the modules installed on  a system.
	* **ansible-doc** can be used to get more information on modules

* **Running Arbitrary Commands on Managed Hosts**
* the *command* module allows admins to run arbitrary commands on the command line of managed hosts
* *-a* is used to pass the command to the module

```
ansible mymanagedhosts -m command -a /usr/biin/hostname
```

* For situations where commands require shell processing, admins can use the *shell* module
* The commands when using *shell* are run through a shell on the managed hosts making shell operations such as redirection, piping, and env variables available.

### Configuring Connections for Ad Hoc Commands
* The host connection and privilege escalation configurations set in the the ansible config file can be passed into ad hoc commands as options:

|Directive		|Command-line Option	|
|---------------|-----------------------|
|inventory		|-i						|
|remote_user	|-u						|
|become			|--become, -b			|
|become_method	|--become-method		|
|become_user	|--become-user			|
|become_ask_pass|--ask-become-pass, -K	|















